#!/bin/bash
set -e

echo "Cleaning up old builds..."
rm -rf build/
mkdir -p build/rpm build/deb build/aur build/tarball build/windows bin

echo "Building .rpm"
cargo rpm build
mv target/release/rpmbuild/RPMS/x86_64/* build/rpm/ 2>/dev/null || true

echo "Building .deb"
cargo deb
mv target/debian/* build/deb/ 2>/dev/null || true

echo "Building AUR package"
cargo aur

AUR_PACKAGE_DIR=$(find target/cargo-aur -type d -name "*.pkg.tar.zst" -exec dirname {} \;)
tar -czvf build/aur/aur_package.tar.gz -C "$AUR_PACKAGE_DIR" . 2>/dev/null || true

echo "Building tarball"
cargo build --release
tar -czvf build/tarball/cuur.tar.gz -C target/release cuur 2>/dev/null || true

echo "Building Windows package"
cargo build --target x86_64-pc-windows-gnu --release
mv target/x86_64-pc-windows-gnu/release/*.exe build/windows/ 2>/dev/null || true

echo "Successfully built all of the packages"

echo "Deploying..."
sleep 1

echo "Copying packages to bin directory..."

if cp -r build/rpm/* bin/ 2>/dev/null; then
  echo "RPM packages copied successfully."
else
  echo "Failed to copy RPM packages."
fi

if cp -r build/deb/* bin/ 2>/dev/null; then
  echo "DEB packages copied successfully."
else
  echo "Failed to copy DEB packages."
fi

if cp -r build/aur/* bin/ 2>/dev/null; then
  echo "AUR packages copied successfully."
else
  echo "Failed to copy AUR packages."
fi

if cp -r build/tarball/* bin/ 2>/dev/null; then
  echo "Tarball packages copied successfully."
else
  echo "Failed to copy Tarball packages."
fi

if cp -r build/windows/* bin/ 2>/dev/null; then
  echo "Windows packages copied successfully."
else
  echo "Failed to copy Windows packages."
fi

echo "Completed building"
