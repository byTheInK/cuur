#!/bin/bash
set -e

echo "Cleaning up old builds..."
rm -rf build/
mkdir -p build/rpm build/deb build/aur build/tarball build/windows final_build_dir

echo "Building .rpm"
cargo rpm build
mv target/release/rpmbuild/RPMS/x86_64/* build/rpm/ 2>/dev/null || true

echo "Building .deb"
cargo deb
mv target/debian/* build/deb/ 2>/dev/null || true

echo "Building AUR package"
cargo aur

AUR_PACKAGE_DIR=$(find target/cargo-aur -type d -name "*.pkg.tar.zst" -exec dirname {} \;)
tar -czvf build/aur/aur_package.tar.gz -C "$AUR_PACKAGE_DIR" . 2>/dev/null || true

echo "Building tarball"
cargo build --release
tar -czvf build/tarball/cuur.tar.gz -C target/release cuur 2>/dev/null || true

echo "Building Windows package"
cargo build --target x86_64-pc-windows-gnu --release
mv target/x86_64-pc-windows-gnu/release/*.exe build/windows/ 2>/dev/null || true

echo "Successfully built all of the packages"

echo "Deploying..."
sleep 1

echo "Copying packages to final directory..."
cp -r build/rpm/* final_build/ 2>/dev/null || true
cp -r build/deb/* final_build/ 2>/dev/null || true
cp -r build/aur/* final_build/ 2>/dev/null || true
cp -r build/tarball/* final_build/ 2>/dev/null || true
cp -r build/windows/* final_build/ 2>/dev/null || true
